<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0d1117">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Superficies Implícitas 4D — f(x,y,z,t)=0</title>
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <style>
    :root {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-tertiary: #21262d;
      --border: #30363d;
      --text-primary: #e6edf3;
      --text-secondary: #8b949e;
      --accent: #58a6ff;
      --accent-hover: #79b8ff;
      --success: #3fb950;
      --warning: #d29922;
      --error: #f85149;
      --radius: 8px;
      --shadow: 0 4px 24px rgba(0,0,0,0.4);
      --transition: 0.2s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }

    .app {
      max-width: 1600px;
      margin: 0 auto;
      padding: 1.5rem;
      display: grid;
      grid-template-columns: 340px 1fr;
      grid-template-rows: auto 1fr;
      gap: 1.5rem;
      min-height: 100vh;
    }

    @media (max-width: 1024px) {
      .app {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto 1fr;
      }
    }

    header {
      grid-column: 1 / -1;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }

    header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: -0.02em;
    }

    header p {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    .panel {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem;
      box-shadow: var(--shadow);
    }

    .panel-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      font-size: 0.8125rem;
      color: var(--text-secondary);
      margin-bottom: 0.35rem;
    }

    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 0.5rem 0.75rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 0.875rem;
      font-family: 'Consolas', 'Monaco', monospace;
      transition: border-color var(--transition);
    }

    input[type="text"]:focus,
    input[type="number"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.2);
    }

    .row-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 500;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background var(--transition), transform 0.1s ease;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn:hover {
      background: var(--border);
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
      border-color: var(--accent-hover);
    }

    .btn-success {
      background: var(--success);
      color: #fff;
      border-color: var(--success);
    }

    .btn-success:hover {
      filter: brightness(1.1);
    }

    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .examples .btn {
      font-size: 0.8125rem;
      padding: 0.4rem 0.75rem;
    }

    .slider-wrap {
      margin: 0.5rem 0;
    }

    .slider-wrap input[type="range"] {
      width: 100%;
      height: 6px;
      -webkit-appearance: none;
      background: var(--bg-tertiary);
      border-radius: 3px;
      margin: 0.5rem 0;
    }

    .slider-wrap input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      transition: transform var(--transition);
    }

    .slider-wrap input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.1);
    }

    .time-display {
      font-family: 'Consolas', monospace;
      font-size: 0.875rem;
      color: var(--accent);
      padding: 0.35rem 0;
    }

    .controls-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.75rem;
    }

    .controls-row .btn {
      flex: 0 0 auto;
    }

    .viz-container {
      grid-column: 1 / -1;
      min-height: 520px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    @media (min-width: 1025px) {
      .viz-container {
        grid-column: 2;
        grid-row: 2;
        min-height: 0;
      }
    }

    #plot3d {
      width: 100%;
      height: 100%;
      min-height: 480px;
    }

    .message {
      padding: 0.75rem 1rem;
      border-radius: 6px;
      font-size: 0.875rem;
      margin-top: 0.75rem;
      display: none;
    }

    .message.error {
      background: rgba(248, 81, 73, 0.15);
      border: 1px solid var(--error);
      color: #ff7b72;
    }

    .message.success {
      background: rgba(63, 185, 80, 0.15);
      border: 1px solid var(--success);
      color: #3fb950;
    }

    .message.visible {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .resolution-select {
      margin-bottom: 1rem;
    }

    .resolution-select select {
      width: 100%;
      padding: 0.5rem 0.75rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 0.875rem;
      cursor: pointer;
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(13, 17, 23, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
      border-radius: var(--radius);
    }

    .loading-overlay.visible {
      display: flex;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    @media (min-width: 1025px) {
      .sidebar {
        grid-row: 2;
      }
    }
  </style>
  <link rel="stylesheet" href="style-mobile.css">
</head>
<body>
  <div class="app">
    <header>
      <div class="header-mobile">
        <div class="header-text">
          <h1>Superficies implícitas 4D</h1>
          <p>Visualización de f(x,y,z,t) = 0 — t como parámetro temporal. Rotar: arrastrar · Zoom: scroll</p>
        </div>
        <button type="button" class="hamburger" id="btnHamburger" aria-label="Abrir o cerrar controles" aria-expanded="false">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
    </header>

    <p class="mobile-warning" id="mobileWarning" role="status">Mejor experiencia en desktop</p>

    <div class="sidebar-wrapper">
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-inner">
      <section class="panel">
        <h2 class="panel-title">Ecuación y rangos</h2>
        <div class="form-group">
          <label for="equation">f(x, y, z, t) = 0</label>
          <input type="text" id="equation" placeholder="ej: sin(sqrt(x*x+y*y)-t)-z" value="sin(sqrt(x*x+y*y)-t)-z">
        </div>
        <div class="form-group row-2">
          <div>
            <label>x_min</label>
            <input type="number" id="xMin" value="-5" step="any">
          </div>
          <div>
            <label>x_max</label>
            <input type="number" id="xMax" value="5" step="any">
          </div>
        </div>
        <div class="form-group row-2">
          <div>
            <label>y_min</label>
            <input type="number" id="yMin" value="-5" step="any">
          </div>
          <div>
            <label>y_max</label>
            <input type="number" id="yMax" value="5" step="any">
          </div>
        </div>
        <div class="form-group row-2">
          <div>
            <label>z_min</label>
            <input type="number" id="zMin" value="-3" step="any">
          </div>
          <div>
            <label>z_max</label>
            <input type="number" id="zMax" value="3" step="any">
          </div>
        </div>
        <div class="form-group row-2">
          <div>
            <label>t_min</label>
            <input type="number" id="tMin" value="0" step="any">
          </div>
          <div>
            <label>t_max</label>
            <input type="number" id="tMax" value="6.28" step="any">
          </div>
        </div>
        <div class="form-group resolution-select">
          <label for="resolution">Resolución de malla</label>
          <select id="resolution">
            <option value="12">Baja (12³) — rápido</option>
            <option value="18" selected>Media (18³)</option>
            <option value="24">Alta (24³)</option>
            <option value="28">Muy alta (28³) — lento</option>
          </select>
        </div>
        <button type="button" class="btn btn-primary" id="btnUpdate" style="width:100%">Actualizar superficie</button>
        <div id="msgEquation" class="message"></div>
      </section>

      <section class="panel">
        <h2 class="panel-title">Ejemplos</h2>
        <div class="examples btn-group">
          <button type="button" class="btn" data-example="wave">Onda</button>
          <button type="button" class="btn" data-example="sphere">Esfera pulsante</button>
          <button type="button" class="btn" data-example="torus">Toroide</button>
          <button type="button" class="btn" data-example="wave2">Ondulante</button>
        </div>
      </section>

      <section class="panel">
        <h2 class="panel-title">Tiempo (t)</h2>
        <div class="slider-wrap">
          <label>t = <span id="tValue" class="time-display">0</span></label>
          <input type="range" id="tSlider" min="0" max="1000" value="0" step="1">
        </div>
        <div class="controls-row">
          <button type="button" class="btn btn-success" id="btnPlay" title="Play/Pause">▶ Play</button>
          <button type="button" class="btn" id="btnReset" title="Reset">↺ Reset</button>
          <select id="speed">
            <option value="0.5">Lento</option>
            <option value="1" selected>Normal</option>
            <option value="2">Rápido</option>
          </select>
        </div>
        <div id="msgTime" class="message"></div>
      </section>
      <section class="panel">
        <h2 class="panel-title">Rendimiento</h2>
        <button type="button" class="btn btn-low-power" id="btnLowPower" title="Reduce resolución para ahorrar batería">Modo bajo consumo</button>
      </section>
        </div>
      </aside>
    </div>

    <div class="viz-container" style="position:relative">
      <div id="plot3d"></div>
      <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
      </div>
    </div>
  </div>

  <script>
    (function() {
      'use strict';

      const DEFAULTS = {
        examples: {
          wave: {
            eq: 'sin(sqrt(x*x+y*y)-t)-z',
            xMin: -5, xMax: 5, yMin: -5, yMax: 5, zMin: -3, zMax: 3, tMin: 0, tMax: 6.28
          },
          sphere: {
            eq: 'x*x+y*y+z*z-(2+sin(t))',
            xMin: -2.5, xMax: 2.5, yMin: -2.5, yMax: 2.5, zMin: -2.5, zMax: 2.5, tMin: 0, tMax: 6.28
          },
          torus: {
            eq: 'pow(sqrt(x*x+y*y)-2,2)+z*z-(1+0.3*cos(t))',
            xMin: -4, xMax: 4, yMin: -4, yMax: 4, zMin: -2, zMax: 2, tMin: 0, tMax: 6.28
          },
          wave2: {
            eq: 'z-sin(x+t)*cos(y+t)',
            xMin: -4, xMax: 4, yMin: -4, yMax: 4, zMin: -2, zMax: 2, tMin: 0, tMax: 6.28
          }
        }
      };

      function createEvaluator(equationStr) {
        const allowed = ['sin', 'cos', 'sqrt', 'exp', 'log', 'abs', 'pow', 'tan', 'Math', 'x', 'y', 'z', 't', 'PI', 'E'];
        const normalized = equationStr
          .replace(/\^/g, '**')
          .replace(/\b(\d+)\.(\d+)\b/g, '$1.$2')
          .replace(/\b(sin|cos|sqrt|exp|log|abs|tan)\s*\(/g, 'Math.$1(')
          .replace(/\bpow\s*\(/g, 'Math.pow(');
        try {
          const fn = new Function('x', 'y', 'z', 't', `
            "use strict";
            const sin = Math.sin, cos = Math.cos, sqrt = Math.sqrt, exp = Math.exp;
            const log = Math.log, abs = Math.abs, pow = Math.pow, tan = Math.tan;
            const PI = Math.PI, E = Math.E;
            return (${normalized});
          `);
          return fn;
        } catch (e) {
          throw new Error('Ecuación inválida: ' + e.message);
        }
      }

      const EDGE_TABLE = new Uint32Array([
        0, 265, 515, 778, 1030, 1295, 1541, 1792, 2060, 2317, 2575, 2822, 3082, 3331, 3593, 3840,
        1040, 1289, 1555, 1802, 2046, 2311, 2565, 2816, 3084, 3333, 3589, 3842, 4098, 4355, 4609, 4864,
        3040, 3289, 3555, 3802, 4046, 4311, 4565, 4816, 5084, 5333, 5589, 5842, 6098, 6355, 6609, 6864,
        4000, 4249, 4515, 4762, 5006, 5271, 5525, 5776, 6044, 6293, 6549, 6802, 7058, 7315, 7569, 7824,
        104, 361, 619, 874, 1134, 1399, 1645, 1896, 2164, 2421, 2679, 2926, 3186, 3435, 3697, 3944,
        1144, 1393, 1659, 1906, 2150, 2415, 2669, 2920, 3188, 3437, 3693, 3946, 4202, 4459, 4713, 4968,
        3144, 3393, 3659, 3906, 4150, 4415, 4669, 4920, 5188, 5437, 5693, 5946, 6202, 6459, 6713, 6968,
        4104, 4353, 4619, 4866, 5110, 5375, 5629, 5880, 6148, 6397, 6653, 6906, 7162, 7419, 7673, 7928,
        208, 457, 723, 970, 1222, 1487, 1741, 1992, 2260, 2509, 2765, 3018, 3274, 3531, 3785, 4040,
        1248, 1497, 1763, 2010, 2254, 2519, 2773, 3024, 3292, 3541, 3797, 4050, 4306, 4563, 4817, 5072,
        3248, 3497, 3763, 4010, 4254, 4519, 4773, 5024, 5292, 5541, 5797, 6050, 6306, 6563, 6817, 7072,
        4208, 4457, 4723, 4970, 5214, 5479, 5733, 5984, 6252, 6501, 6757, 7010, 7266, 7523, 7777, 8032,
        312, 569, 827, 1082, 1342, 1607, 1853, 2104, 2372, 2629, 2887, 3134, 3394, 3643, 3905, 4152,
        1352, 1601, 1867, 2114, 2358, 2623, 2877, 3128, 3396, 3645, 3901, 4154, 4410, 4667, 4921, 5176,
        3352, 3601, 3867, 4114, 4358, 4623, 4877, 5128, 5396, 5645, 5901, 6154, 6410, 6667, 6921, 7176,
        4312, 4561, 4827, 5074, 5318, 5583, 5837, 6088, 6356, 6605, 6861, 7114, 7370, 7627, 7881, 8136
      ]);

      const TRI_TABLE = [
        [], [0,8,3], [0,1,9], [1,8,3,9,8,1], [1,2,10], [0,8,3,1,2,10], [9,2,10,0,2,9], [2,8,3,2,10,8,10,9,8],
        [3,11,2], [0,11,2,8,11,0], [1,9,0,2,3,11], [1,11,2,1,9,11,9,8,11], [3,10,1,11,10,3], [0,10,1,0,8,10,8,11,10], [3,9,0,3,11,9,11,10,9], [9,8,10,10,8,11],
        [4,7,8], [4,3,0,7,3,4], [0,1,9,8,4,7], [4,1,9,4,7,1,7,3,1], [1,2,10,8,4,7], [3,4,7,3,0,4,1,2,10], [9,2,10,9,0,2,8,4,7], [2,10,9,2,9,7,2,7,3,7,9,4],
        [8,4,7,3,11,2], [11,4,7,11,2,4,2,0,4], [9,0,1,8,4,7,2,3,11], [4,7,11,9,4,11,9,11,2,9,2,1], [1,2,10,8,4,7,3,11], [2,10,1,11,10,2,11,2,0,11,0,4,11,4,7], [10,9,0,10,0,2,11,4,7,11,2,4,2,11,0], [9,4,7,9,7,10,10,7,11,2,10,11,1,2,9,2,1,9],
        [3,4,7,3,0,4,0,1,4], [1,4,7,1,7,3], [0,4,7,0,7,9,9,7,3,9,3,1], [9,4,7,1,9,7,1,7,3], [10,1,2,8,4,7], [2,10,1,0,8,4,0,4,7,0,7,3], [4,7,8,10,0,2,10,9,0], [2,10,9,2,9,7,2,7,3,9,4,7],
        [8,4,7,3,11,2,10,1,9], [10,1,9,11,0,4,11,4,7], [10,2,11,10,11,0,10,0,9,8,4,7], [10,2,11,9,10,11,9,11,4,9,4,7], [1,2,10,8,4,7,3,11], [2,10,1,11,10,2,0,11,2,4,11,0,7,11,4], [9,0,2,9,2,10,8,2,0,8,4,2,8,7,4], [9,4,7,10,9,7,10,7,11,10,11,2],
        [4,9,5], [0,8,3,4,9,5], [0,1,5,4,1,0], [8,4,5,8,5,3,3,5,1], [1,2,10,9,5,4], [3,0,8,1,2,10,4,9,5], [5,2,10,5,4,2,4,0,2], [2,10,5,2,5,4,2,4,8,2,8,3],
        [9,5,4,2,3,11], [0,11,2,0,8,11,4,9,5], [0,1,5,4,1,0,2,3,11], [2,1,5,2,5,8,2,8,11,4,8,5], [10,3,11,10,1,3,9,5,4], [4,9,5,8,0,1,8,1,10,8,10,11], [5,4,0,5,0,11,5,11,10,11,0,3], [5,4,8,5,8,10,10,8,11],
        [9,7,8,5,7,9], [9,3,0,9,5,3,5,7,3], [0,7,8,0,1,7,1,5,7], [1,5,3,3,5,7], [9,7,8,9,5,7,10,1,2], [10,1,2,9,5,0,5,3,0,5,7,3], [8,0,2,8,2,5,8,5,7,10,5,2], [2,10,5,2,5,3,3,5,7],
        [7,9,5,7,8,9,3,11,2], [9,5,7,9,7,2,9,2,0,2,7,11], [2,3,11,0,1,8,1,7,8,1,5,7], [11,2,1,11,1,7,7,1,5], [9,5,8,8,5,7,10,1,3,10,3,11], [5,7,9,7,5,8,3,11,0,1,10,11,1,0], [11,0,2,11,2,10,7,9,5,7,5,8,5,0,8], [11,2,10,7,11,10,7,10,5,7,5,9],
        [2,5,10,2,3,5,3,7,5], [8,2,0,8,5,2,8,7,5,10,2,5], [9,0,1,5,10,3,5,3,7,3,10,2], [9,8,2,9,2,1,8,7,2,10,2,5,7,5,2], [1,3,5,3,7,5], [0,8,7,0,7,1,1,7,5], [9,0,3,9,3,5,5,3,7], [9,8,7,9,7,5],
        [5,8,4,5,10,8,10,11,8], [5,0,4,5,11,0,5,10,11], [0,1,9,8,4,10,8,10,11,10,4,5], [10,11,4,10,4,5,11,1,4,11,0,1], [8,4,7,2,5,10,2,3,5,3,7,5], [10,2,5,2,4,5,2,0,4,7,5,3], [9,0,1,8,4,7,2,10,5,2,5,3,5,7,3], [9,4,7,9,7,2,9,2,1,10,5,2],
        [6,2,1,6,7,2,7,3,2], [6,2,1,8,6,1,8,7,6], [0,7,8,0,2,7,2,6,7], [2,6,7,2,7,3], [1,6,7,1,10,6,1,0,10,0,8,10], [11,6,7,1,10,0], [0,8,10,0,10,2,8,7,10,6,10,7], [7,3,2,7,2,6,6,2,10],
        [1,6,7,1,10,6,3,11,2], [1,6,7,1,10,6,11,2,0,11,0,8], [0,2,8,2,6,8,2,10,6,8,6,7], [7,3,2,7,2,6,6,2,10], [1,10,6,1,6,7,1,7,0,8,0,7], [11,6,7,11,0,6,0,1,6], [7,11,6,7,0,11,7,8,0,6,10,0], [7,11,6,10,6,11],
        [6,11,7,6,2,11,6,9,2,6,1,9], [1,9,6,1,6,7,1,7,8,8,7,11], [2,9,6,2,6,1,2,11,6,7,6,11], [9,6,1,9,1,8,8,1,7,11,7,1], [6,11,7,2,11,6,2,9,11,2,1,9], [8,11,7,8,2,11,8,0,2,9,6,1], [11,7,6,2,11,6,2,6,1,2,1,0], [11,7,6,11,6,0,0,6,1,8,0,1],
        [6,7,10,10,7,8,10,8,9], [6,7,10,10,7,0,10,0,9,0,7,3], [6,7,8,6,8,10,10,8,0], [7,3,6,6,3,10,10,3,0], [1,0,9,10,6,7,10,7,8], [10,6,7,10,7,1,1,7,3], [10,6,7,10,7,0,0,7,8], [10,6,7,3,10,7],
        [1,9,2,1,2,11,9,6,2,9,7,6], [7,1,9,7,9,6,6,9,2,6,2,11], [8,9,0,2,11,6,2,6,7], [7,2,11,7,6,2], [8,1,9,8,0,1,6,11,7], [11,7,6,11,6,0,0,6,1], [7,8,0,7,0,6,6,0,1,6,1,10], [7,6,11,1,10,0],
        [10,7,6,10,9,7,10,1,9], [1,9,0,10,7,6,10,6,11], [11,7,6,11,6,0,0,6,9], [7,6,11,11,6,9], [6,7,10,1,9,8,1,8,0], [10,7,6,10,6,1,1,6,0], [6,7,10,6,10,0,0,10,9], [6,7,10,9,6,10]
      ];

      const EDGE_VERTICES = [
        [0,1], [1,2], [2,3], [3,0], [4,5], [5,6], [6,7], [7,4], [0,4], [1,5], [2,6], [3,7]
      ];

      const CUBE_CORNERS = [
        [0,0,0],[1,0,0],[1,1,0],[0,1,0],[0,0,1],[1,0,1],[1,1,1],[0,1,1]
      ];

      function marchingCubes(f, xMin, xMax, yMin, yMax, zMin, zMax, t, n) {
        const dx = (xMax - xMin) / n, dy = (yMax - yMin) / n, dz = (zMax - zMin) / n;
        const vertices = [];
        const faces = [];
        const vertexMap = new Map();

        function vertexKey(i, j, k, edge) {
          return `${i},${j},${k},${edge}`;
        }

        function getVertex(i, j, k, e) {
          const key = vertexKey(i, j, k, e);
          if (vertexMap.has(key)) return vertexMap.get(key);
          const [a, b] = EDGE_VERTICES[e];
          const [ia, ja, ka] = CUBE_CORNERS[a];
          const [ib, jb, kb] = CUBE_CORNERS[b];
          const x0 = xMin + (i + ia) * dx, x1 = xMin + (i + ib) * dx;
          const y0 = yMin + (j + ja) * dy, y1 = yMin + (j + jb) * dy;
          const z0 = zMin + (k + ka) * dz, z1 = zMin + (k + kb) * dz;
          const v0 = f(x0, y0, z0, t), v1 = f(x1, y1, z1, t);
          const denom = v1 - v0;
          const t_param = Math.abs(denom) < 1e-10 ? 0.5 : -v0 / denom;
          const t_clamp = Math.max(0, Math.min(1, t_param));
          const x = x0 + t_clamp * (x1 - x0);
          const y = y0 + t_clamp * (y1 - y0);
          const z = z0 + t_clamp * (z1 - z0);
          const idx = vertices.length / 3;
          vertices.push(x, y, z);
          vertexMap.set(key, idx);
          return idx;
        }

        const grid = new Float64Array((n + 1) * (n + 1) * (n + 1));
        for (let k = 0; k <= n; k++)
          for (let j = 0; j <= n; j++)
            for (let i = 0; i <= n; i++)
              grid[(k * (n + 1) + j) * (n + 1) + i] = f(xMin + i * dx, yMin + j * dy, zMin + k * dz, t);

        for (let k = 0; k < n; k++)
          for (let j = 0; j < n; j++)
            for (let i = 0; i < n; i++) {
              let cellIndex = 0;
              const base = (k * (n + 1) + j) * (n + 1) + i;
              const v = [
                grid[base], grid[base + 1], grid[base + (n + 1) + 1], grid[base + (n + 1)],
                grid[base + (n + 1) * (n + 1)], grid[base + (n + 1) * (n + 1) + 1],
                grid[base + (n + 1) * (n + 1) + (n + 1) + 1], grid[base + (n + 1) * (n + 1) + (n + 1)]
              ];
              for (let c = 0; c < 8; c++) if (v[c] <= 0) cellIndex |= 1 << c;
              const edges = EDGE_TABLE[cellIndex];
              if (edges === 0) continue;
              let tri = TRI_TABLE[cellIndex];
              let reverseWinding = false;
              if (!tri && cellIndex >= 128) {
                tri = TRI_TABLE[255 - cellIndex];
                reverseWinding = tri && tri.length > 0;
              }
              if (!tri || tri.length === 0) continue;
              for (let idx = 0; idx < tri.length; idx += 3) {
                const e0 = tri[idx], e1 = tri[idx + 1], e2 = tri[idx + 2];
                const i0 = getVertex(i, j, k, e0);
                const i1 = getVertex(i, j, k, e1);
                const i2 = getVertex(i, j, k, e2);
                if (reverseWinding) faces.push(i0, i2, i1);
                else faces.push(i0, i1, i2);
              }
            }

        return { vertices, faces };
      }

      const elements = {
        equation: document.getElementById('equation'),
        xMin: document.getElementById('xMin'),
        xMax: document.getElementById('xMax'),
        yMin: document.getElementById('yMin'),
        yMax: document.getElementById('yMax'),
        zMin: document.getElementById('zMin'),
        zMax: document.getElementById('zMax'),
        tMin: document.getElementById('tMin'),
        tMax: document.getElementById('tMax'),
        resolution: document.getElementById('resolution'),
        btnUpdate: document.getElementById('btnUpdate'),
        btnPlay: document.getElementById('btnPlay'),
        btnReset: document.getElementById('btnReset'),
        tSlider: document.getElementById('tSlider'),
        tValue: document.getElementById('tValue'),
        speed: document.getElementById('speed'),
        msgEquation: document.getElementById('msgEquation'),
        msgTime: document.getElementById('msgTime'),
        plot3d: document.getElementById('plot3d'),
        loadingOverlay: document.getElementById('loadingOverlay'),
        examples: document.querySelectorAll('[data-example]'),
        btnHamburger: document.getElementById('btnHamburger'),
        sidebar: document.getElementById('sidebar'),
        mobileWarning: document.getElementById('mobileWarning'),
        btnLowPower: document.getElementById('btnLowPower')
      };

      let currentFn = null;
      let animId = null;
      let isPlaying = false;
      let lastUpdate = 0;
      let sliderDebounce = null;

      function isMobile() {
        return window.matchMedia('(max-width: 768px)').matches || 'ontouchstart' in window;
      }

      function isLowPower() {
        return document.body.classList.contains('mode-low-power');
      }

      var plotlyConfig = { responsive: true, displayModeBar: true };

      function showMsg(el, text, type) {
        el.textContent = text;
        el.className = 'message ' + (type || '') + ' visible';
      }

      function hideMsg(el) {
        el.className = 'message';
      }

      function getT() {
        const tMin = parseFloat(elements.tMin.value) || 0;
        const tMax = parseFloat(elements.tMax.value) || 1;
        const v = parseInt(elements.tSlider.value, 10) / 1000;
        return tMin + v * (tMax - tMin);
      }

      function setTValue(val) {
        const tMin = parseFloat(elements.tMin.value) || 0;
        const tMax = parseFloat(elements.tMax.value) || 1;
        const v = Math.max(0, Math.min(1, (val - tMin) / ((tMax - tMin) || 1)));
        elements.tSlider.value = Math.round(v * 1000);
        elements.tValue.textContent = val.toFixed(4);
      }

      function getRanges() {
        return {
          xMin: parseFloat(elements.xMin.value) || -5,
          xMax: parseFloat(elements.xMax.value) || 5,
          yMin: parseFloat(elements.yMin.value) || -5,
          yMax: parseFloat(elements.yMax.value) || 5,
          zMin: parseFloat(elements.zMin.value) || -3,
          zMax: parseFloat(elements.zMax.value) || 3,
          tMin: parseFloat(elements.tMin.value) || 0,
          tMax: parseFloat(elements.tMax.value) || 6.28
        };
      }

      function computeMesh(t) {
        if (!currentFn) return null;
        const r = getRanges();
        let maxRes = 32;
        if (isMobile()) maxRes = 12;
        if (isLowPower()) maxRes = 10;
        const requested = parseInt(elements.resolution.value, 10) || 18;
        const n = Math.min(maxRes, Math.max(8, isLowPower() ? 10 : requested));
        return marchingCubes(currentFn, r.xMin, r.xMax, r.yMin, r.yMax, r.zMin, r.zMax, t, n);
      }

      function updatePlot(t) {
        if (!currentFn) return;
        elements.loadingOverlay.classList.add('visible');
        requestAnimationFrame(function doUpdate() {
          const mesh = computeMesh(t);
          elements.loadingOverlay.classList.remove('visible');
          if (!mesh || mesh.vertices.length === 0) {
            Plotly.react(elements.plot3d, [{
              x: [0], y: [0], z: [0], mode: 'markers', type: 'scatter3d',
              marker: { size: 1, color: 'rgba(0,0,0,0)' }
            }], {
              margin: { l: 0, r: 0, t: 0, b: 0 },
              paper_bgcolor: 'rgba(22,27,34,1)',
              scene: {
                bgcolor: 'rgba(22,27,34,1)',
                xaxis: { title: 'X', gridcolor: '#30363d', color: '#8b949e' },
                yaxis: { title: 'Y', gridcolor: '#30363d', color: '#8b949e' },
                zaxis: { title: 'Z', gridcolor: '#30363d', color: '#8b949e' }
              }
            }, plotlyConfig);
            return;
          }
          const v = mesh.vertices;
          const x = [], y = [], z = [];
          for (let i = 0; i < v.length; i += 3) {
            x.push(v[i]); y.push(v[i + 1]); z.push(v[i + 2]);
          }
          const r = getRanges();
          const zNorm = z.map(zi => (zi - r.zMin) / ((r.zMax - r.zMin) || 1));
          const colorscale = [[0, 'rgba(88,166,255,0.9)'], [0.5, 'rgba(63,185,80,0.9)'], [1, 'rgba(210,153,34,0.9)']];
          const trace = {
            type: 'mesh3d',
            x, y, z,
            i: mesh.faces.filter((_, i) => i % 3 === 0),
            j: mesh.faces.filter((_, i) => i % 3 === 1),
            k: mesh.faces.filter((_, i) => i % 3 === 2),
            intensity: zNorm,
            colorscale,
            flatshading: false,
            lighting: { ambient: 0.6, diffuse: 0.8, specular: 0.2 }
          };
          Plotly.react(elements.plot3d, [trace], {
            margin: { l: 0, r: 0, t: 0, b: 0 },
            paper_bgcolor: 'rgba(22,27,34,1)',
            scene: {
              bgcolor: 'rgba(22,27,34,1)',
              xaxis: { title: 'X', range: [r.xMin, r.xMax], gridcolor: '#30363d', color: '#8b949e' },
              yaxis: { title: 'Y', range: [r.yMin, r.yMax], gridcolor: '#30363d', color: '#8b949e' },
              zaxis: { title: 'Z', range: [r.zMin, r.zMax], gridcolor: '#30363d', color: '#8b949e' }
            }
          }, plotlyConfig);
        });
      }

      function buildAndUpdate() {
        hideMsg(elements.msgEquation);
        try {
          currentFn = createEvaluator(elements.equation.value.trim());
          const t = getT();
          setTValue(t);
          updatePlot(t);
        } catch (err) {
          showMsg(elements.msgEquation, err.message, 'error');
        }
      }

      function onSliderInput() {
        const t = getT();
        setTValue(t);
        if (currentFn && !isPlaying) {
          if (sliderDebounce) clearTimeout(sliderDebounce);
          sliderDebounce = setTimeout(() => { updatePlot(t); sliderDebounce = null; }, 120);
        }
      }

      var animFrameCount = 0;
      var mobileFpsThrottle = 3;
      function togglePlay() {
        isPlaying = !isPlaying;
        elements.btnPlay.textContent = isPlaying ? '⏸ Pause' : '▶ Play';
        elements.btnPlay.classList.toggle('btn-success', isPlaying);
        if (isPlaying) {
          lastUpdate = performance.now();
          animFrameCount = 0;
          function loop(now) {
            if (!isPlaying) return;
            animId = requestAnimationFrame(loop);
            var doUpdate = true;
            if (isMobile()) {
              animFrameCount++;
              doUpdate = (animFrameCount % mobileFpsThrottle === 0);
            }
            const speed = parseFloat(elements.speed.value) || 1;
            const r = getRanges();
            const dt = (now - lastUpdate) / 1000 * (r.tMax - r.tMin) * 0.15 * speed;
            lastUpdate = now;
            let t = getT() + dt;
            if (t > r.tMax) t = r.tMin + (t - r.tMax);
            if (t < r.tMin) t = r.tMax - (r.tMin - t);
            setTValue(t);
            if (doUpdate) updatePlot(t);
          }
          animId = requestAnimationFrame(loop);
        } else if (animId != null) {
          cancelAnimationFrame(animId);
          animId = null;
        }
      }

      function resetTime() {
        const r = getRanges();
        setTValue(r.tMin);
        if (currentFn) updatePlot(r.tMin);
      }

      if (elements.btnHamburger && elements.sidebar) {
        elements.btnHamburger.addEventListener('click', function() {
          const open = elements.sidebar.classList.toggle('is-open');
          elements.btnHamburger.setAttribute('aria-expanded', open);
        });
      }

      if (elements.mobileWarning && isMobile()) {
        elements.mobileWarning.classList.add('is-mobile');
      }

      if (elements.btnLowPower) {
        elements.btnLowPower.addEventListener('click', function() {
          document.body.classList.toggle('mode-low-power');
          const on = document.body.classList.contains('mode-low-power');
          elements.btnLowPower.textContent = on ? 'Desactivar bajo consumo' : 'Modo bajo consumo';
          if (currentFn) updatePlot(getT());
        });
      }

      plotlyConfig.displayModeBar = !isMobile();

      elements.btnUpdate.addEventListener('click', buildAndUpdate);
      elements.tSlider.addEventListener('input', onSliderInput);
      elements.btnPlay.addEventListener('click', togglePlay);
      elements.btnReset.addEventListener('click', resetTime);

      elements.examples.forEach(btn => {
        btn.addEventListener('click', function() {
          const key = this.getAttribute('data-example');
          const ex = DEFAULTS.examples[key];
          if (!ex) return;
          elements.equation.value = ex.eq;
          elements.xMin.value = ex.xMin;
          elements.xMax.value = ex.xMax;
          elements.yMin.value = ex.yMin;
          elements.yMax.value = ex.yMax;
          elements.zMin.value = ex.zMin;
          elements.zMax.value = ex.zMax;
          elements.tMin.value = ex.tMin;
          elements.tMax.value = ex.tMax;
          elements.tSlider.value = 0;
          buildAndUpdate();
        });
      });

      setTValue(getRanges().tMin);
      buildAndUpdate();
    })();
  </script>
</body>
</html>
