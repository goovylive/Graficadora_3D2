<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#0d1117">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Superficies Impl√≠citas 4D ‚Äî f(x,y,z,t)=0</title>
  <link rel="manifest" href="manifest.json">
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script>
    // URL de la API en Hugging Face
    const API_URL = 'https://goovylive-implicit-surface-api.hf.space';

    async function wakeUpServer() {
      const statusEl = document.getElementById('serverStatus');
      if (statusEl) {
        statusEl.textContent = 'üü° Conectando con servidor...';
        statusEl.style.color = '#d29922';
      }
      try {
        const response = await fetch(`${API_URL}/health`, {
          signal: AbortSignal.timeout(90000)
        });
        if (response.ok) {
          console.log('‚úÖ Servidor listo');
          if (statusEl) {
            statusEl.textContent = 'üü¢ Servidor listo';
            statusEl.style.color = '#3fb950';
            setTimeout(() => { statusEl.textContent = ''; }, 3000);
          }
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è Servidor iniciando...');
        if (statusEl) {
          statusEl.textContent = 'üî¥ Servidor iniciando, espera un momento...';
          statusEl.style.color = '#f85149';
        }
      }
    }

    setInterval(async () => {
      try {
        await fetch(`${API_URL}/health`);
      } catch (e) {}
    }, 4 * 60 * 1000);

    wakeUpServer();
  </script>
  <style>
    :root {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-tertiary: #21262d;
      --border: #30363d;
      --text-primary: #e6edf3;
      --text-secondary: #8b949e;
      --accent: #58a6ff;
      --accent-hover: #79b8ff;
      --success: #3fb950;
      --warning: #d29922;
      --error: #f85149;
      --radius: 8px;
      --shadow: 0 4px 24px rgba(0,0,0,0.4);
      --transition: 0.2s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }

    .app {
      max-width: 1600px;
      margin: 0 auto;
      padding: 1.5rem;
      display: grid;
      grid-template-columns: 340px 1fr;
      grid-template-rows: auto 1fr;
      gap: 1.5rem;
      min-height: 100vh;
    }

    @media (max-width: 1024px) {
      .app {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto 1fr;
      }
    }

    header {
      grid-column: 1 / -1;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }

    header h1 {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: -0.02em;
    }

    header p {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    .panel {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem;
      box-shadow: var(--shadow);
    }

    .panel-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      font-size: 0.8125rem;
      color: var(--text-secondary);
      margin-bottom: 0.35rem;
    }

    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 0.5rem 0.75rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 0.875rem;
      font-family: 'Consolas', 'Monaco', monospace;
      transition: border-color var(--transition);
    }

    input[type="text"]:focus,
    input[type="number"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.2);
    }

    .row-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-weight: 500;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background var(--transition), transform 0.1s ease;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn:hover {
      background: var(--border);
    }

    .btn:active {
      transform: scale(0.98);
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
      border-color: var(--accent-hover);
    }

    .btn-success {
      background: var(--success);
      color: #fff;
      border-color: var(--success);
    }

    .btn-success:hover {
      filter: brightness(1.1);
    }

    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .examples .btn {
      font-size: 0.8125rem;
      padding: 0.4rem 0.75rem;
    }

    .slider-wrap {
      margin: 0.5rem 0;
    }

    .slider-wrap input[type="range"] {
      width: 100%;
      height: 6px;
      -webkit-appearance: none;
      background: var(--bg-tertiary);
      border-radius: 3px;
      margin: 0.5rem 0;
    }

    .slider-wrap input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--accent);
      cursor: pointer;
      transition: transform var(--transition);
    }

    .slider-wrap input[type="range"]::-webkit-slider-thumb:hover {
      transform: scale(1.1);
    }

    .time-display {
      font-family: 'Consolas', monospace;
      font-size: 0.875rem;
      color: var(--accent);
      padding: 0.35rem 0;
    }

    .controls-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.75rem;
    }

    .controls-row .btn {
      flex: 0 0 auto;
    }

    .viz-container {
      grid-column: 1 / -1;
      min-height: 520px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    @media (min-width: 1025px) {
      .viz-container {
        grid-column: 2;
        grid-row: 2;
        min-height: 0;
      }
    }

    #plot3d {
      width: 100%;
      height: 100%;
      min-height: 480px;
    }

    .message {
      padding: 0.75rem 1rem;
      border-radius: 6px;
      font-size: 0.875rem;
      margin-top: 0.75rem;
      display: none;
    }

    .message.error {
      background: rgba(248, 81, 73, 0.15);
      border: 1px solid var(--error);
      color: #ff7b72;
    }

    .message.success {
      background: rgba(63, 185, 80, 0.15);
      border: 1px solid var(--success);
      color: #3fb950;
    }

    .message.warning {
      background: rgba(210, 153, 34, 0.15);
      border: 1px solid var(--warning);
      color: #d29922;
    }

    .message.visible {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .resolution-select {
      margin-bottom: 1rem;
    }

    .resolution-select select {
      width: 100%;
      padding: 0.5rem 0.75rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 0.875rem;
      cursor: pointer;
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(13, 17, 23, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10;
      border-radius: var(--radius);
    }

    .loading-overlay.visible {
      display: flex;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    @media (min-width: 1025px) {
      .sidebar {
        grid-row: 2;
      }
    }
  </style>
  <link rel="stylesheet" href="style-mobile.css">
</head>
<body>
  <div class="app">
    <header>
      <div class="header-mobile">
        <div class="header-text">
          <h1>Superficies impl√≠citas 4D</h1>
          <p>Visualizaci√≥n de f(x,y,z,t) = 0 ‚Äî t como par√°metro temporal. Rotar: arrastrar ¬∑ Zoom: scroll</p>
        </div>
        <button type="button" class="hamburger" id="btnHamburger" aria-label="Abrir o cerrar controles" aria-expanded="false">
          <span></span>
          <span></span>
          <span></span>
        </button>
      </div>
      <div id="serverStatus" style="
        font-size: 0.78rem;
        font-weight: 600;
        margin-top: 4px;
        transition: all 0.3s ease;
      "></div>
    </header>

    <p class="mobile-warning" id="mobileWarning" role="status">Mejor experiencia en desktop</p>

    <div class="sidebar-wrapper">
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-inner">
      <section class="panel">
        <h2 class="panel-title">Ecuaci√≥n y rangos</h2>
        <div class="form-group">
          <label for="equation">f(x, y, z, t) = 0</label>
          <input type="text" id="equation" placeholder="ej: sin(sqrt(x*x+y*y)-t)-z" value="sin(sqrt(x*x+y*y)-t)-z">
        </div>
        <div class="form-group row-2">
          <div>
            <label>x_min</label>
            <input type="number" id="xMin" value="-5" step="any">
          </div>
          <div>
            <label>x_max</label>
            <input type="number" id="xMax" value="5" step="any">
          </div>
        </div>
        <div class="form-group row-2">
          <div>
            <label>y_min</label>
            <input type="number" id="yMin" value="-5" step="any">
          </div>
          <div>
            <label>y_max</label>
            <input type="number" id="yMax" value="5" step="any">
          </div>
        </div>
        <div class="form-group row-2">
          <div>
            <label>z_min</label>
            <input type="number" id="zMin" value="-3" step="any">
          </div>
          <div>
            <label>z_max</label>
            <input type="number" id="zMax" value="3" step="any">
          </div>
        </div>
        <div class="form-group row-2">
          <div>
            <label>t_min</label>
            <input type="number" id="tMin" value="0" step="any">
          </div>
          <div>
            <label>t_max</label>
            <input type="number" id="tMax" value="6.28" step="any">
          </div>
        </div>
        <div class="form-group resolution-select">
          <label for="resolution">Resoluci√≥n de malla</label>
          <select id="resolution" class="form-control">
            <option value="10">Baja (10¬≥) - R√°pida</option>
            <option value="14">Media-Baja (14¬≥)</option>
            <option value="18" selected>Media (18¬≥)</option>
            <option value="24">Alta (24¬≥) - Lenta</option>
            <option value="32">Muy Alta (32¬≥) - Muy Lenta</option>
          </select>
        </div>
        <button type="button" class="btn btn-primary" id="btnUpdate" style="width:100%">Actualizar superficie</button>
        <div class="form-group">
          <small style="color: var(--text-secondary); font-size: 0.75rem;">
            ‚ö†Ô∏è Los c√°lculos se realizan en servidor. Mayor resoluci√≥n = m√°s tiempo de espera.
          </small>
        </div>
        <div id="msgEquation" class="message"></div>
      </section>

      <section class="panel">
        <h2 class="panel-title">Ejemplos</h2>
        <div class="examples btn-group">
          <button type="button" class="btn" data-example="wave">Onda</button>
          <button type="button" class="btn" data-example="sphere">Esfera pulsante</button>
          <button type="button" class="btn" data-example="torus">Toroide</button>
          <button type="button" class="btn" data-example="wave2">Ondulante</button>
        </div>
      </section>

      <section class="panel">
        <h2 class="panel-title">Tiempo (t)</h2>
        <div class="form-group">
          <label for="animDuration">Duraci√≥n de animaci√≥n (segundos)</label>
          <input type="number" id="animDuration" value="10" min="3" max="60" step="1">
          <small style="color: var(--text-secondary); font-size: 0.7rem;">
            Tiempo que tarda en completar un ciclo completo
          </small>
        </div>
        <div class="form-group">
          <label for="targetFPS">Frames por segundo (FPS)</label>
          <select id="targetFPS">
            <option value="15">15 FPS - Bajo (r√°pido)</option>
            <option value="24">24 FPS - Medio</option>
            <option value="30" selected>30 FPS - Alto</option>
            <option value="60">60 FPS - Ultra (lento)</option>
          </select>
          <small style="color: var(--text-secondary); font-size: 0.7rem;">
            Mayor FPS = m√°s suave pero m√°s tiempo de pre-c√°lculo
          </small>
        </div>
        <div class="slider-wrap">
          <label>t = <span id="tValue" class="time-display">0</span></label>
          <input type="range" id="tSlider" min="0" max="1000" value="0" step="1">
        </div>
        <div class="controls-row">
          <button type="button" class="btn btn-success" id="btnPlay" title="Play/Pause">‚ñ∂ Play</button>
          <button type="button" class="btn" id="btnPrecalc" title="Pre-calcular frames">üé¨ Pre-calcular</button>
          <button type="button" class="btn" id="btnReset" title="Reset">‚Ü∫ Reset</button>
          <select id="speed">
            <option value="0.5">Lento</option>
            <option value="1" selected>Normal</option>
            <option value="2">R√°pido</option>
          </select>
        </div>
        <div id="msgTime" class="message"></div>
      </section>
      <section class="panel">
        <h2 class="panel-title">Rendimiento</h2>
        <button type="button" class="btn btn-low-power" id="btnLowPower" title="Reduce resoluci√≥n para ahorrar bater√≠a">Modo bajo consumo</button>
      </section>
        </div>
      </aside>
    </div>

    <div class="viz-container" style="position:relative">
      <div id="plot3d"></div>
      <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
      </div>
      <div id="apiIndicator" style="
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 6px 12px;
        background: rgba(88, 166, 255, 0.2);
        border: 1px solid rgba(88, 166, 255, 0.4);
        border-radius: 4px;
        color: #58a6ff;
        font-size: 0.75rem;
        font-weight: 600;
        display: none;
        z-index: 9999;
        backdrop-filter: blur(4px);
      ">
        <span>‚óè</span> Procesando...
      </div>
    </div>
  </div>

  <script>
    (function() {
      'use strict';

      const DEFAULTS = {
        examples: {
          wave: {
            eq: 'sin(sqrt(x*x+y*y)-t)-z',
            xMin: -5, xMax: 5, yMin: -5, yMax: 5, zMin: -3, zMax: 3, tMin: 0, tMax: 6.28
          },
          sphere: {
            eq: 'x*x+y*y+z*z-(2+sin(t))',
            xMin: -2.5, xMax: 2.5, yMin: -2.5, yMax: 2.5, zMin: -2.5, zMax: 2.5, tMin: 0, tMax: 6.28
          },
          torus: {
            eq: 'pow(sqrt(x*x+y*y)-2,2)+z*z-(1+0.3*cos(t))',
            xMin: -4, xMax: 4, yMin: -4, yMax: 4, zMin: -2, zMax: 2, tMin: 0, tMax: 6.28
          },
          wave2: {
            eq: 'z-sin(x+t)*cos(y+t)',
            xMin: -4, xMax: 4, yMin: -4, yMax: 4, zMin: -2, zMax: 2, tMin: 0, tMax: 6.28
          }
        }
      };

      const elements = {
        equation: document.getElementById('equation'),
        xMin: document.getElementById('xMin'),
        xMax: document.getElementById('xMax'),
        yMin: document.getElementById('yMin'),
        yMax: document.getElementById('yMax'),
        zMin: document.getElementById('zMin'),
        zMax: document.getElementById('zMax'),
        tMin: document.getElementById('tMin'),
        tMax: document.getElementById('tMax'),
        resolution: document.getElementById('resolution'),
        btnUpdate: document.getElementById('btnUpdate'),
        btnPlay: document.getElementById('btnPlay'),
        btnReset: document.getElementById('btnReset'),
        tSlider: document.getElementById('tSlider'),
        tValue: document.getElementById('tValue'),
        speed: document.getElementById('speed'),
        msgEquation: document.getElementById('msgEquation'),
        msgTime: document.getElementById('msgTime'),
        plot3d: document.getElementById('plot3d'),
        loadingOverlay: document.getElementById('loadingOverlay'),
        examples: document.querySelectorAll('[data-example]'),
        btnHamburger: document.getElementById('btnHamburger'),
        sidebar: document.getElementById('sidebar'),
        mobileWarning: document.getElementById('mobileWarning'),
        btnLowPower: document.getElementById('btnLowPower'),
        animDuration: document.getElementById('animDuration'),
        targetFPS: document.getElementById('targetFPS'),
        btnPrecalc: document.getElementById('btnPrecalc')
      };

      let currentFn = null;
      let animId = null;
      let isPlaying = false;
      let lastUpdate = 0;
      let sliderDebounce = null;
      let frameCache = [];
      let isCaching = false;
      let cacheProgress = 0;

      function showApiIndicator() {
        const el = document.getElementById('apiIndicator');
        if (el) el.style.display = 'block';
      }

      function hideApiIndicator() {
        const el = document.getElementById('apiIndicator');
        if (el) el.style.display = 'none';
      }

      function isMobile() {
        return window.matchMedia('(max-width: 768px)').matches || 'ontouchstart' in window;
      }

      function isLowPower() {
        return document.body.classList.contains('mode-low-power');
      }

      var plotlyConfig = { responsive: true, displayModeBar: true };

      function showMsg(el, text, type) {
        el.textContent = text;
        el.className = 'message ' + (type || '') + ' visible';
      }

      function hideMsg(el) {
        el.className = 'message';
      }

      function getT() {
        const tMin = parseFloat(elements.tMin.value) || 0;
        const tMax = parseFloat(elements.tMax.value) || 1;
        const v = parseInt(elements.tSlider.value, 10) / 1000;
        return tMin + v * (tMax - tMin);
      }

      function setTValue(val) {
        const tMin = parseFloat(elements.tMin.value) || 0;
        const tMax = parseFloat(elements.tMax.value) || 1;
        const v = Math.max(0, Math.min(1, (val - tMin) / ((tMax - tMin) || 1)));
        elements.tSlider.value = Math.round(v * 1000);
        elements.tValue.textContent = val.toFixed(4);
      }

      function getRanges() {
        return {
          xMin: parseFloat(elements.xMin.value) || -5,
          xMax: parseFloat(elements.xMax.value) || 5,
          yMin: parseFloat(elements.yMin.value) || -5,
          yMax: parseFloat(elements.yMax.value) || 5,
          zMin: parseFloat(elements.zMin.value) || -3,
          zMax: parseFloat(elements.zMax.value) || 3,
          tMin: parseFloat(elements.tMin.value) || 0,
          tMax: parseFloat(elements.tMax.value) || 6.28
        };
      }

      function normalizeEquation(eq) {
        if (!eq) return eq;
        eq = eq.replace(/\^/g, '**');
        eq = eq.trim();
        return eq;
      }

      function calculateNumFrames() {
        const r = getRanges();
        const tRange = r.tMax - r.tMin;
        const animDuration = parseFloat(elements.animDuration?.value || document.getElementById('animDuration')?.value) || 10;
        const targetFPS = parseFloat(elements.targetFPS?.value || document.getElementById('targetFPS')?.value) || 30;
        const numFrames = Math.round(animDuration * targetFPS);
        const limitedFrames = Math.max(10, Math.min(300, numFrames));
        const tStep = tRange / limitedFrames;
        console.log(`üìä Configuraci√≥n de pre-c√°lculo:
    - Rango temporal: ${r.tMin} ‚Üí ${r.tMax} (${tRange.toFixed(2)}s)
    - Duraci√≥n animaci√≥n: ${animDuration}s
    - FPS objetivo: ${targetFPS}
    - Frames a calcular: ${limitedFrames}
    - Paso temporal: ${tStep.toFixed(4)}
  `);
        return {
          numFrames: limitedFrames,
          tStep: tStep,
          animDuration: animDuration
        };
      }

      function getMeshFromCache(t) {
        if (frameCache.length === 0) return null;
        let prev = frameCache[0];
        let next = frameCache[0];
        for (let i = 0; i < frameCache.length - 1; i++) {
          if (frameCache[i].t <= t && frameCache[i + 1].t >= t) {
            prev = frameCache[i];
            next = frameCache[i + 1];
            break;
          }
        }
        if (Math.abs(t - next.t) < Math.abs(t - prev.t)) {
          return next.mesh;
        }
        return prev.mesh;
      }

      async function precalculateFrames() {
        if (!currentFn) return false;
        frameCache = [];
        isCaching = true;
        const r = getRanges();
        const config = calculateNumFrames();
        const { numFrames, tStep } = config;
        elements.loadingOverlay.classList.add('visible');
        showMsg(elements.msgTime, `Pre-calculando ${numFrames} frames (0%)...`, '');
        for (let i = 0; i <= numFrames; i++) {
          const t = r.tMin + i * tStep;
          try {
            const mesh = await computeMesh(t);
            if (mesh) {
              frameCache.push({ t: t, mesh: mesh });
            }
            cacheProgress = Math.round((i / numFrames) * 100);
            showMsg(elements.msgTime, `Pre-calculando ${numFrames} frames (${cacheProgress}%)...`, '');
          } catch (error) {
            console.error('Error pre-calculando frame:', error);
          }
        }
        elements.loadingOverlay.classList.remove('visible');
        hideMsg(elements.msgTime);
        isCaching = false;
        const totalTime = Math.round(frameCache.length * 1.5);
        showMsg(elements.msgTime, `‚úì ${frameCache.length} frames listos (~${totalTime}s de c√°lculo)`, 'success');
        setTimeout(() => hideMsg(elements.msgTime), 3000);
        return frameCache.length > 0;
      }

      async function computeMesh(t) {
        if (!currentFn) return null;
        const r = getRanges();
        const n = Math.min(32, Math.max(8, parseInt(elements.resolution.value, 10) || 18));

        const MAX_RETRIES = 5;
        const TIMEOUT_MS = 120000;

        showApiIndicator();

        for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
          try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_MS);

            const response = await fetch(`${API_URL}/compute-mesh`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                equation: normalizeEquation(elements.equation.value.trim()),
                ranges: {
                  xMin: r.xMin,
                  xMax: r.xMax,
                  yMin: r.yMin,
                  yMax: r.yMax,
                  zMin: r.zMin,
                  zMax: r.zMax
                },
                t: t,
                resolution: n
              }),
              signal: controller.signal
            });

            clearTimeout(timeoutId);

            if (!response.ok) {
              const errBody = await response.json().catch(() => ({}));
              const detail = errBody.detail || 'Error al calcular la malla';
              throw new Error(typeof detail === 'string' ? detail : JSON.stringify(detail));
            }

            const data = await response.json();
            hideApiIndicator();
            return {
              vertices: data.vertices,
              faces: data.faces
            };
          } catch (error) {
            console.error(`Intento ${attempt}/${MAX_RETRIES} fall√≥:`, error);

            if (error.name === 'AbortError') {
              showMsg(elements.msgEquation, `Tiempo de espera agotado (${attempt}/${MAX_RETRIES}). Prueba menor resoluci√≥n.`, 'warning');
            } else if (error.message && error.message.toLowerCase().includes('fetch')) {
              showMsg(elements.msgEquation, `Servidor no disponible (${attempt}/${MAX_RETRIES}). El servidor puede estar iniciando.`, 'warning');
            } else if (error.message && (error.message.includes('ecuaci√≥n') || error.message.includes('evaluar'))) {
              showMsg(elements.msgEquation, error.message, 'error');
            } else if (attempt === MAX_RETRIES) {
              hideApiIndicator();
              showMsg(elements.msgEquation, 'Error de conexi√≥n con el servidor despu√©s de varios intentos. Intenta con menor resoluci√≥n o m√°s tarde.', 'error');
              return null;
            } else {
              showMsg(elements.msgTime, `Reintentando (${attempt}/${MAX_RETRIES})...`, 'warning');
            }

            await new Promise(resolve => setTimeout(resolve, 2000 * attempt));
          }
        }

        hideApiIndicator();
        return null;
      }

      async function updatePlot(t) {
        if (!currentFn) return;

        let mesh = null;

        if (isPlaying && frameCache.length > 0) {
          mesh = getMeshFromCache(t);
        } else {
          if (!isPlaying) {
            elements.loadingOverlay.classList.add('visible');
            showMsg(elements.msgTime, 'Calculando en servidor...', '');
          }
          mesh = await computeMesh(t);
          elements.loadingOverlay.classList.remove('visible');
          hideMsg(elements.msgTime);
        }

        try {
          if (!mesh || mesh.vertices.length === 0) {
            Plotly.react(elements.plot3d, [{
              x: [0], y: [0], z: [0], mode: 'markers', type: 'scatter3d',
              marker: { size: 1, color: 'rgba(0,0,0,0)' }
            }], {
              margin: { l: 0, r: 0, t: 0, b: 0 },
              paper_bgcolor: 'rgba(22,27,34,1)',
              scene: {
                bgcolor: 'rgba(22,27,34,1)',
                xaxis: { title: 'X', gridcolor: '#30363d', color: '#8b949e' },
                yaxis: { title: 'Y', gridcolor: '#30363d', color: '#8b949e' },
                zaxis: { title: 'Z', gridcolor: '#30363d', color: '#8b949e' }
              }
            }, plotlyConfig);
            return;
          }

          const v = mesh.vertices;
          const x = [], y = [], z = [];
          for (let i = 0; i < v.length; i += 3) {
            x.push(v[i]);
            y.push(v[i + 1]);
            z.push(v[i + 2]);
          }

          const r = getRanges();
          const zNorm = z.map(zi => (zi - r.zMin) / ((r.zMax - r.zMin) || 1));
          const colorscale = [[0, 'rgba(88,166,255,0.9)'], [0.5, 'rgba(63,185,80,0.9)'], [1, 'rgba(210,153,34,0.9)']];
          const trace = {
            type: 'mesh3d',
            x, y, z,
            i: mesh.faces.filter((_, i) => i % 3 === 0),
            j: mesh.faces.filter((_, i) => i % 3 === 1),
            k: mesh.faces.filter((_, i) => i % 3 === 2),
            intensity: zNorm,
            colorscale,
            flatshading: false,
            lighting: { ambient: 0.6, diffuse: 0.8, specular: 0.2 }
          };
          Plotly.react(elements.plot3d, [trace], {
            margin: { l: 0, r: 0, t: 0, b: 0 },
            paper_bgcolor: 'rgba(22,27,34,1)',
            scene: {
              bgcolor: 'rgba(22,27,34,1)',
              xaxis: { title: 'X', range: [r.xMin, r.xMax], gridcolor: '#30363d', color: '#8b949e' },
              yaxis: { title: 'Y', range: [r.yMin, r.yMax], gridcolor: '#30363d', color: '#8b949e' },
              zaxis: { title: 'Z', range: [r.zMin, r.zMax], gridcolor: '#30363d', color: '#8b949e' }
            }
          }, plotlyConfig);
        } catch (error) {
          elements.loadingOverlay.classList.remove('visible');
          hideMsg(elements.msgTime);
          console.error('Error al actualizar plot:', error);
        }
      }

      async function buildAndUpdate() {
        hideMsg(elements.msgEquation);
        frameCache = [];
        console.log('üóëÔ∏è Cach√© limpiado - ecuaci√≥n o par√°metros modificados');
        currentFn = true;
        const t = getT();
        setTValue(t);
        await updatePlot(t);
      }

      function onSliderInput() {
        const t = getT();
        setTValue(t);
        if (currentFn && !isPlaying) {
          if (sliderDebounce) clearTimeout(sliderDebounce);
          sliderDebounce = setTimeout(async () => {
            await updatePlot(t);
            sliderDebounce = null;
          }, 500);
        }
      }

      function togglePlay() {
        if (!isPlaying) {
          if (frameCache.length === 0) {
            (async () => {
              const success = await precalculateFrames();
              if (!success) {
                showMsg(elements.msgEquation, 'Error al pre-calcular animaci√≥n', 'error');
                return;
              }
              startAnimation();
            })();
          } else {
            startAnimation();
          }
        } else {
          stopAnimation();
        }
      }

      function startAnimation() {
        isPlaying = true;
        elements.btnPlay.textContent = '‚è∏ Pause';
        elements.btnPlay.classList.add('btn-success');
        const r = getRanges();
        const config = calculateNumFrames();
        const tRange = r.tMax - r.tMin;
        const speedFactor = tRange / config.animDuration;
        lastUpdate = performance.now();

        function loop(now) {
          if (!isPlaying) return;
          animId = requestAnimationFrame(loop);
          const userSpeed = parseFloat(elements.speed.value) || 1;
          const dt = (now - lastUpdate) / 1000 * speedFactor * userSpeed;
          lastUpdate = now;
          let t = getT() + dt;
          if (t > r.tMax) t = r.tMin + (t - r.tMax);
          if (t < r.tMin) t = r.tMax - (r.tMin - t);
          setTValue(t);
          updatePlot(t);
        }
        animId = requestAnimationFrame(loop);
      }

      function stopAnimation() {
        isPlaying = false;
        elements.btnPlay.textContent = '‚ñ∂ Play';
        elements.btnPlay.classList.remove('btn-success');
        if (animId != null) {
          cancelAnimationFrame(animId);
          animId = null;
        }
      }

      async function resetTime() {
        const r = getRanges();
        setTValue(r.tMin);
        if (currentFn) await updatePlot(r.tMin);
      }

      if (elements.btnHamburger && elements.sidebar) {
        elements.btnHamburger.addEventListener('click', function() {
          const open = elements.sidebar.classList.toggle('is-open');
          elements.btnHamburger.setAttribute('aria-expanded', open);
        });
      }

      if (elements.mobileWarning && isMobile()) {
        elements.mobileWarning.classList.add('is-mobile');
      }

      if (elements.btnLowPower) {
        elements.btnLowPower.addEventListener('click', function() {
          document.body.classList.toggle('mode-low-power');
          const on = document.body.classList.contains('mode-low-power');
          elements.btnLowPower.textContent = on ? 'Desactivar bajo consumo' : 'Modo bajo consumo';
          if (currentFn) updatePlot(getT());
        });
      }

      plotlyConfig.displayModeBar = !isMobile();

      elements.btnUpdate.addEventListener('click', buildAndUpdate);
      elements.tSlider.addEventListener('input', onSliderInput);
      elements.btnPlay.addEventListener('click', togglePlay);
      elements.btnReset.addEventListener('click', resetTime);

      if (elements.btnPrecalc) {
        elements.btnPrecalc.addEventListener('click', async () => {
          await precalculateFrames();
        });
      }

      if (elements.tMin) {
        elements.tMin.addEventListener('change', () => {
          if (frameCache.length > 0) {
            frameCache = [];
            console.log('üóëÔ∏è Cach√© limpiado - tMin cambi√≥');
          }
        });
      }
      if (elements.tMax) {
        elements.tMax.addEventListener('change', () => {
          if (frameCache.length > 0) {
            frameCache = [];
            console.log('üóëÔ∏è Cach√© limpiado - tMax cambi√≥');
          }
        });
      }

      elements.examples.forEach(btn => {
        btn.addEventListener('click', function() {
          const key = this.getAttribute('data-example');
          const ex = DEFAULTS.examples[key];
          if (!ex) return;
          elements.equation.value = ex.eq;
          elements.xMin.value = ex.xMin;
          elements.xMax.value = ex.xMax;
          elements.yMin.value = ex.yMin;
          elements.yMax.value = ex.yMax;
          elements.zMin.value = ex.zMin;
          elements.zMax.value = ex.zMax;
          elements.tMin.value = ex.tMin;
          elements.tMax.value = ex.tMax;
          elements.tSlider.value = 0;
          buildAndUpdate();
        });
      });

      setTValue(getRanges().tMin);
      buildAndUpdate();
    })();
  </script>
</body>
</html>
